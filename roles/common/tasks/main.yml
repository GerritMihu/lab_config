---
- name: Basis-Pakete installieren
  apt:
    name:
      - git
      - curl
      - vim
      - unattended-upgrades
      - apt-transport-https
      - ca-certificates
      - gnupg2
    state: present
    update_cache: yes
    cache_valid_time: 3600  # Cache für 1 Stunde gültig

- name: Unattended Upgrades konfigurieren (Debian-spezifisch)
  block:
    - name: Konfigurationsdatei für automatische Updates
      copy:
        dest: /etc/apt/apt.conf.d/50unattended-upgrades
        mode: '0644'
        content: |
          Unattended-Upgrade::Origins-Pattern {
              "origin=Debian,codename=${distro_codename},label=Debian-Security";
          };
          Unattended-Upgrade::Package-Blacklist {
          };
          Unattended-Upgrade::Automatic-Reboot "true";
          Unattended-Upgrade::Remove-Unused-Dependencies "true";
          Unattended-Upgrade::SyslogEnable "true";

    - name: Periodische Updates aktivieren
      copy:
        dest: /etc/apt/apt.conf.d/20auto-upgrades
        mode: '0644'
        content: |
          APT::Periodic::Update-Package-Lists "1";
          APT::Periodic::Unattended-Upgrade "1";
          APT::Periodic::Download-Upgradeable-Packages "1";

    - name: Service neu starten
      service:
        name: unattended-upgrades
        state: restarted
        enabled: yes

- name: APT-Proxy für Lab-Umgebung (optional)
  copy:
    dest: /etc/apt/apt.conf.d/01proxy
    mode: '0644'
    content: |
      Acquire::HTTP::Proxy "http://{{ apt_proxy_server | default('10.0.0.10') }}:3142";
      Acquire::HTTPS::Proxy "false";
  when: apt_proxy_enabled | default(false) | bool

- name: Standard-KDE-Einstellungen (für Lab-PCs)
  block:
    - name: Lab-Wallpaper setzen
      copy:
        src: files/lab.jpg
        dest: /usr/share/wallpapers/lab.jpg
        mode: '0644'

    - name: KDE-Autostart für Wallpaper
      copy:
        dest: /etc/xdg/autostart/lab-wallpaper.desktop
        mode: '0644'
        content: |
          [Desktop Entry]
          Type=Application
          Name=Set Lab Wallpaper
          Exec=pcmanfm --set-wallpaper /usr/share/wallpapers/lab.jpg
          OnlyShowIn=KDE;
  when: "'kde' in group_names"  # Nur auf KDE-PCs ausführen
